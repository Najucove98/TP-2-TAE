---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerias usadas
#library(tidyverse) #Solo poner las librerias que usemos
library(dplyr) #manipulacion de datos
library(ggplot2) #graficar
#library(readxl) #leectura de archivos
library(lubridate) #manipulacion de datos
library(echarts4r) #grafico linea temporal
library(leaflet.extras) #para crear el mapa de calor
library(countrycode) #para codificar los paises
library(rnaturalearth) # Para obtener los poligonos de cada pais
#library(sf) no usamos

# Carga de los datos
cookies <- read.delim("cookies.txt")

# Exploración de los datos
# summary(cookies)
```
# Introducción

Este informe presenta un análisis descriptivo de la base de datos de un sitio web de compras online, con el objetivo de encontrar distintas relaciones entre las variables provistas.

La base de datos original contiene variables clave como:

- ID: número que identifica a cada visitante del sitio web.
- fecha: fecha de la visita al sitio web.
- clicks: cantidad de clicks realizados durante la visita al sitio web.
- paginas: cantidad de páginas accedidas durante la visita al sitio web.
- tiempo: duración de la visita al sitio web, en segundos.
- gasto: valor monetario de las compras realizadas durante la visita al sitio web, en dólares.
- browser: tipo de navegador desde el que accedió al sitio web.
- dispositivo: tipo de dispositivo desde el que accedió al sitio web.
- pais: país de residencia del visitante del sitio web.

## ¿La distribución geográfica de las visitas refleja una concentración considerablemente marcada en determinado país?

```{r}
cookies_paises <- cookies %>%
  mutate(
    country = countrycode(
      sourcevar = pais,
      origin = "country.name.en",
      destination = "iso2c", # El código de destino es ISO de 2 letras
      nomatch = NA_character_ # Si no encuentra el nombre, pone NA
    )
  ) %>%
  filter(!is.na(country)) %>%
  group_by(country, pais) %>%
  summarise(Total_Visitas = n(),
            Total_Usuarios = n_distinct(ID))


limites_mundiales <- ne_countries(scale = "medium", returnclass = "sf") %>%
  select(iso_a2, geometry)

# 1. Unir los datos agregados con los límites geográficos
#    La unión se realiza por el código ISO de 2 letras (iso_a2 en el mapa, country en tus datos)
mapa_datos <- limites_mundiales %>%
  left_join(cookies_paises, by = c("iso_a2" = "country")) %>%
  # Filtrar para dejar solo los países que tienen visitas (Total_Visitas > 0 o no NA)
  filter(!is.na(Total_Visitas))

# 2. Definir la paleta de colores (más visitas = rojo más oscuro)
paleta_colores <- colorNumeric(
  palette = "YlOrRd", # paletas usadas Blues, Reds, viridis, magma, YlOrRd
  domain = mapa_datos$Total_Visitas)


# 3. Generar el Mapa Coroplético
mapa_datos %>%
  leaflet() %>%
  addProviderTiles('OpenStreetMap.Mapnik') %>% # addProviderTiles("NASAGIBS.ViirsEarthAtNight2012")
  addPolygons(
    fillColor = ~paleta_colores(Total_Visitas), # Colorea según la variable Total_Visitas
    weight = 1, # Grosor de las fronteras
    opacity = 1,
    color = "grey", # Color de las fronteras
    dashArray = "3",
    fillOpacity = 0.8, # Transparencia del color
    # Agrega un PopUp para mostrar el total de visitas al hacer clic
    popup = ~paste0("País: ", pais, 
                    "<br>Total Visitas: ", Total_Visitas, 
                    "<br>Total Usuarios: ", Total_Usuarios)
  ) %>%
  # Agregar la leyenda para interpretar los colores
  addLegend(
    pal = paleta_colores,
    values = ~Total_Visitas,
    opacity = 0.7,
    title = "Total de Visitas",
    position = "bottomright"
  )
```

El mapa muestra la distribución geográfica del total de visitas al sitio web durante el período analizado. Se observa una marcada concentración en Estados Unidos, país que registra un volumen de accesos significativamente superior al resto del mundo, lo cual podria ocasinar una fuerte dependencia comercial con el mercado estadounidense. 

Debido a esto, podría recomendarse una expasión a nivel internacional de la página web
para que de esta manera se amplie la base de clientes potenciales.

## ¿Cómo evolucionó la cantidad de compras a lo largo de las semanas analizadas?

```{r}
datos_tiempo <- cookies  |> 
  mutate(grupo = ifelse(pais == "United States", "Estados Unidos", "Otros"),
         fecha = ymd(as.character(fecha)),
         semana = floor_date(fecha, unit = "week")) |> 
  group_by(semana, grupo) |> # si agrupamos por fecha o semana se grafica la linea de tiempo diario o semanal respectivamente
  summarise(gasto_dia = sum(gasto, na.rm = TRUE), .groups = "drop")

#una mejor visualizacion del grafico anterior
datos_tiempo %>%
  group_by(grupo) %>% # Agrupa los datos por 'country' (país).
  e_charts(x = semana) %>% # mapeando 'year' al eje X.
  e_line(serie = gasto_dia) %>% # usa 'pobl' como los valores de la serie (eje Y).
  e_title("Evolución semanal del gasto total ") %>% # Define el título del gráfico interactivo.
  e_x_axis(name = "Semana", serie = semana) %>% # Define el nombre del eje X y usa la columna 'year' como datos.
  e_y_axis(name = "Gasto (en USD)") %>% # Define el nombre del eje y.
  e_legend(orient = "vertical", left = "10%", top = "10%") %>% # Personaliza la leyenda: orientación vertical, posicionada al 10% desde la izquierda y 10% desde arriba.
  e_tooltip(trigger = "axis") # Configura las tooltips (información emergente al pasar el ratón) para que se muestre al pasar sobre el eje X.

```

El gráfico muestra la evolución semanal del gasto total en el sitio web, diferenciando a Estados Unidos del resto de los paises. 
Se puede observar que el gasto realizado en Estados unidos es ampliamente superior en el periodo de tiempo analizado, ademas de  presentar picos muchos mas marcados en la temporada Abril-Mayo.

El gasto de los demás paises es plano con respecto a Estados Unidos.Esto reafirma lo mencionado en el gráfico anterior, que la actividad económica del sitio se encuentra reducida a este país particular. Los picos se encuentran distribuidos uniformemente a lo largo de los meses. 

## ¿La cantidad de visitas donde se efectuo una compra esta relacionado con el gasto promedio por usuario?

```{r}
library(plotly) 
# Contar cuántas visitas hizo cada ID
visitas_por_id <- cookies |> 
  filter(gasto > 0) %>%
  group_by(ID) %>%
  summarise(n_visitas_efectivas = n(),
            gasto = mean(gasto),
            tiempo = mean(tiempo),
            clicks = mean(clicks),
            paginas = mean(paginas))

grafico <- ggplot(data = visitas_por_id) +
  aes(x = n_visitas_efectivas, 
      y = gasto,
      text = paste0(
    "<b>Visitas efectivas: </b>", n_visitas_efectivas, "<br>",
    "<b>Gasto promedio: </b>", round(gasto, 2), " USD <br>",
    "<b>Tiempo promedio: </b>", round(tiempo, 2), " min <br>",
    "<b>Clicks promedio: </b>", round(clicks), "<br>",
    "<b>Paginas promedio: </b>", round(paginas))) +
  geom_point() +
  labs(x = "Visitas efectivas",
       y = "Gasto promedio",
       title = "Relación Visitas efectivas vs. Gasto promedio") +
  
  theme_bw()

ggplotly(grafico, tooltip = "text")
```

El grafico describe la relacion entre el numero de visitas efectivas y el gasto promedio por usuario donde se observa dos valores atipicos. Por lo cual procedemos a visualizar la mayor concentracion de usuarios.

```{r}
ggplotly(grafico +
  coord_cartesian(xlim = c(0.3, 10), ylim = c(0, 7000)) +
    scale_x_continuous(breaks = seq(0, 10, 1)) +
    scale_y_continuous(breaks = seq(0, 7000, 1000)), tooltip = "text")
```

En el grafico podemos observar que la tendencia del numero de visitas donde se efectuo una compra tiende a disminuir en el promedio del gasto por usuario. Podemos destacar que los usuarios con compras unicas tienen una mayor dispersion sobre su gasto y que la relacion entre mas visitas efectivas y el gasto promedio es inversa a la esperada.

## ¿Que tiempo de permanencia tienen los usuarios segun el navegador y el dispositivo que usa?

```{r}
cookies_navegador <- cookies %>%
  group_by(browser, dispositivo) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE)/60, .groups = "drop") |> 
  mutate(
    dispositivo = case_when(
      dispositivo == "desktop" ~ "Escritorio",
      dispositivo == "mobile"  ~ "Móvil",
      dispositivo == "tablet"  ~ "Tablet"))

cookies_treemap <- cookies_navegador %>%
  group_by(browser) %>%
  summarise(tiempo_total = sum(tiempo_total, na.rm = TRUE)/60) %>%
  ungroup() |> 
  rename(dispositivo = browser) |> 
  mutate(browser = "Tiempo total (minutos)") |> # para identificar la fila total
  bind_rows(cookies_navegador) |> 
  mutate(etiqueta = ifelse(browser != "Tiempo total (minutos)", paste0(dispositivo, " - ", browser), dispositivo))

cookies_treemap |> 
  plot_ly(
  type = "treemap",
  labels = ~etiqueta,
  parents = ~ifelse(dispositivo == "Tiempo total (minutos)", "", browser),
  values = ~tiempo_total,
  hoverinfo = "label+value+percent parent+percent root",
  textinfo = "label+value+percent parent+percent root") |> 
  add_trace(branchvalues = "total", name = "")

```

Segun el grafico podemos observar que los navegadores que mas tiempo de permanencia tienen en la pagina web son Chrome, Safari y Firefox, de los cuales se destaca el uso de dispositivos de escritorio para Chrome y Firefox y el uso de movil para Safari.







