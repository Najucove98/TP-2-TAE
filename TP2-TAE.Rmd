---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerias usadas
library(tidyverse) #Solo poner las librerias que usemos

# Carga de los datos
cookies <- read.delim("cookies.txt")

# Exploración de los datos
summary(cookies)
```
# Introducción


Datos: Google Analytics
Los datos a analizar consisten en registros de Google Analytics, herramienta utilizada para hacer
un seguimiento del comportamiento de los usuarios en un sitio web. En particular, esta base
contiene informaci´on sobre visitas al sitio de compras online https://shop.merch.google/
durante el primer semestre del a˜no 2017. La base se encuentra almacenada en el archivo
cookies.txt y contiene las siguientes variables.
 ID: n´umero que identifica a cada visitante del sitio web.
 fecha: fecha de la visita al sitio web.
 clicks: cantidad de clicks realizados durante la visita al sitio web.
 paginas: cantidad de p´aginas accedidas durante la visita al sitio web.
 tiempo: duraci´on de la visita al sitio web, en segundos.
 gasto: valor monetario de las compras realizadas durante la visita al sitio web, en d´olares.
 browser: tipo de navegador desde el que accedi´o al sitio web.
 dispositivo: tipo de dispositivo desde el que accedi´o al sitio web.
 pais: pa´ıs de residencia del visitante del sitio web.

Consigna
El objetivo de este TP es poner en pr´actica habilidades para la confecci´on de reportes orientados
al an´alisis exploratorio de datos, en particular, mediante las herramientas R Markdown o
Quarto. El reporte debe ser entregado en formato .html o .pdf, junto con el script de
codigo .Rmd o .qmd utilizado. Cada informe deber´a plantear 4 interrogantes, los cuales ser´an
analizados mediante gr´aficos y tablas. 




##Objetivo 1 (grafico de geolocalizacion)

```{r}
cookies %>% 
  count(pais, sort = TRUE)  # cuenta y ordena de mayor a menor
```






```{r}
#Posible interrogante
# Ver la evolucion de la cantidad de compras a lo largo de los meses
# Ver la evoluxion de compras en dias especiales
# ver la evolucion de compras a lo largo del mes

datos_gastos <- filter(cookies, gasto > 0)

datos_gastos %>% 
  count(pais, sort = TRUE)

# 5277 observaciones del total hicieron compras 
#dim(datos_gastos)
filtrado <- gapminder %>% 
  mutate(pobl = pop / 1000000) %>% # Crea la columna 'pobl'
  filter(
    country %in% c("Argentina", "Brazil", "Colombia", "Ecuador", "Chile",
                   "Paraguay", "Bolivia", "Peru", "Uruguay", "Venezuela")
  )


datos_filtrados <- cookies |> 
  filter(
    pais %in% c("United States", "Canada", "Japan", "Taiwan", "Venezuela", "Mexico", "Australia", "Brazil", "Singapore")
  ) |> 
  group_by(pais) |> 
  summarise(count = sum(gasto > 0))



```
```{r}
datos_agrupados <- cookies %>%
  mutate(grupo = ifelse(pais == "United States", "Estados Unidos", "Otros"))

gasto_por_grupo <- datos_agrupados |> 
  mutate(gasto_miles = gasto/1000) |> 
  group_by(grupo) %>%
  summarise(gasto_total = sum(gasto_miles, na.rm = TRUE),
            gasto_promedio = mean(gasto_miles, na.rm = TRUE),
            n_visitas = n()) %>%
  arrange(desc(gasto_total))

ggplot(gasto_por_grupo, aes(x = grupo, y = gasto_total, fill = grupo)) +
  geom_bar(stat = "identity") +
  labs(title = "Gasto total: Estados Unidos vs. Otros países",
       x = "", y = "Gasto total (USD x miles)") +
  theme_minimal() +
  theme(legend.position = "none")
```



```{r} 
# Datos de estados unidos

cookies_eeuu <- filter(cookies, pais == "United States")

summary(cookies_eeuu)

nrow(cookies_eeuu)
```

## Objetivo 2 (linea de tiempo sobre el gasto de estados unidos vs otros)

```{r}
cookies_fecha <- datos_agrupados |>  
  mutate(fecha = as.Date(as.character(fecha), format = "%Y%m%d"))

cookies_dispositivos_diarios <- cookies_fecha |> 
  group_by(fecha, grupo) |> 
  summarise(gasto_dia = sum(gasto, na.rm = TRUE))

#una mejor visualizacion del grafico anterior
cookies_dispositivos_diarios %>%
  group_by(grupo) %>% # Agrupa los datos por 'country' (país).
  e_charts(x = fecha) %>% # mapeando 'year' al eje X.
  e_line(serie = gasto_dia) %>% # usa 'pobl' como los valores de la serie (eje Y).
  e_title("Evolución de la población de los países sudamericanos") %>% # Define el título del gráfico interactivo.
  e_x_axis(name = "Dia", serie = fecha) %>% # Define el nombre del eje X y usa la columna 'year' como datos.
  e_y_axis(name = "Gasto (en USD)") %>% # Define el nombre del eje y.
  e_legend(orient = "vertical", left = "10%", top = "10%") %>% # Personaliza la leyenda: orientación vertical, posicionada al 10% desde la izquierda y 10% desde arriba.
  e_tooltip(trigger = "axis") # Configura las tooltips (información emergente al pasar el ratón) para que se muestre al pasar sobre el eje X.

```

Conclusion



# Objetivo 3

```{r}
usuarios <- cookies |>
  group_by(ID) |> 
  summarise(paginas = sum(paginas, na.rm = TRUE),
            clicks = sum(clicks, na.rm = TRUE),
            tiempo = (sum(tiempo, na.rm = TRUE)/60),
            gasto = sum(gasto, na.rm = T),
            entradas = n()) |> 
  filter(gasto > 0)

grafico <- ggplot(data = usuarios) +
  aes(x = paginas, y = gasto) +
  geom_point()

ggplotly(grafico)

```


Interrogante: ¿Los usuarios que tienen mas paginas/clicks/tiempo accedidas tienden a realizar gastos mas grandes?

```{r}
# Filtrar los datos para individuos con un tiempo de duracion de la visitia al sitio web > 1 (esto elimina valores con clicks = 1 y valores con paginas = 1)

# Grafico de dispersion para ver si hay relacion entre las variables clicks y gasto
# dentro de la base que si gastaron
# comparar con la alternativa : graf de dispersion entre paginas y gasto
```

# Objetivo 4 
utilizar la variable dispositivo para ver relaciones con otras variables

```{r}
table(cookies$browser, cookies$dispositivo)
```

# Objetivo 5 
```{r}
usuarios |> 
  count(entradas, sort = T)

#Idea podemos agrupar por cantidad de entradas unicas y graficar el promedio de los totales
```


Los visitantes frecuentes muestran un gasto mayor o menor que los visitantes unicos (subgrupos de visitantes frecuentes, ¿ == 1 o > 1 ? ) ver como queda por promedio o total, grafico de barras

Ver la relacion entre un usuario mas frecuente gasta mas en la pagina (grafico de dispersion)

```{r}
datos_gastos %>% 
  count(ID, sort = TRUE)


# Contar cuántas visitas hizo cada ID
visitas_por_id <- datos_gastos %>%
  group_by(ID) %>%
  summarise(n_visitas = n(),
            gasto_total = sum(gasto),
            gasto_promedio = mean(gasto))
```

## Objetivo 3

```{r}
# El uso de las tablas dinamicas requiere un procesamiento de los datos

deptos <- cultivos %>%
  filter(                  # Filtra las filas del dataset 'deptos'.
    prov == "SANTA FE",    # Mantiene solo las filas donde la provincia (prov) es "SANTA FE".
    campaña == "2019/20",  # Mantiene solo las filas donde la campaña (campana) es "2019/20".
    !cultivo %in% c("Soja 1ra", "Soja 2da") # Mantiene solo las filas donde el cultivo NO está en el vector
  ) %>%
  group_by(dpto, cultivo) %>% # Agrupa los datos por 'depto' (departamento) y 'cultivo'.
  summarise(               # Calcula valores resumen por cada grupo creado.
    prod = sum(prod, na.rm = TRUE), # Calcula la suma de la columna 'prod' (producción) para cada grupo, ignorando NAs.
    .groups = "drop"       # Indica que se debe eliminar la agrupación después de calcular el resumen.
  )

#---------------------------------------------------------------------------------------------------

deptos_tot <- deptos %>% 
  #Calculo totales por depto
  group_by(dpto) %>%          # Agrupa los datos ÚNICAMENTE por 'depto' (departamento).
  summarise(prod = sum(prod, na.rm = TRUE)) %>% # Calcula la suma de 'prod' (producción) por cada departamento.
  ungroup() %>%                # Elimina la agrupación para que las siguientes operaciones afecten a todo el dataset.
  rename(cultivo = dpto) %>%  # Renombra la columna 'depto' a 'cultivo' (es una preparación para el siguiente paso, donde 'cultivo' representará el total del departamento).
  mutate(dpto = "Total Santa Fe") # Crea/modifica la columna 'depto' y asigna el valor fijo "Total Santa Fe" a todas las filas (esto convierte cada fila en el total de un depto bajo una nueva categoría de "Total Santa Fe").

#---------------------------------------------------------------------------------------------------

#Uno con el dataset original
deptos_tot <- bind_rows(deptos, deptos_tot) # Combina (apila) las filas del dataset original 'deptos_cultivos' con el de totales 'deptos_tot'.

#---------------------------------------------------------------------------------------------------

#Genero etiquetas únicas
deptos_tot <- deptos_tot %>% # Continúa usando el dataset combinado.
  mutate(etiq = ifelse(dpto != "Total Santa Fe", # Crea/modifica la columna 'etiq' (etiqueta).
                       paste0(cultivo, "-", dpto), # Si 'depto' NO es "Total Santa Fe", la etiqueta es "cultivo-depto" (ej: Maiz-Rosario).
                       cultivo)) # Si 'depto' ES "Total Santa Fe", la etiqueta es solo el 'cultivo' (que en este caso es el total del departamento renombrado previamente).

#---------------------------------------------------------------------------------------------------

#Idea con Tablas dinamicas Treemaps
# Inicia la creación de un gráfico interactivo con plotly, utilizando el dataset 'deptos_tot'.
plot_ly(deptos_tot, 
        type = 'treemap',        # Especifica el tipo de gráfico como 'treemap'.
        labels = ~etiq,          # Usa la columna 'etiq' (etiqueta única) para las etiquetas de los rectángulos (jerarquía menor).
        parents = ~deptos_tot$dpto, # Usa la columna 'depto' para la jerarquía superior/padre de los rectángulos.
        values = ~deptos_tot$prod,   # Usa la columna 'prod' (producción) para el tamaño de cada rectángulo.
        hoverinfo = "text",      # Muestra la información de 'text' al pasar el ratón.
        textinfo = "label+value+percent parent+percent root") |>  # Muestra en el gráfico la etiqueta, valor, porcentaje respecto al padre y porcentaje respecto al total.
        add_trace(branchvalues = "total", name = "") # Ajusta cómo se calculan los nodos del treemap y añade la traza al gráfico.
```

```{r}
#Posible interrogante para agregar al treemap
# Ver proporcion de individuos q usan distintos navegadores 
# Ver su relacion con los gastos o con los gastos de estados unidos

# grafico de barras para los dispositivos dentro de la base de estados unidos
cookies %>% 
  count(dispositivo, sort = TRUE)

# grafico de barras para los navegadores dentro de la base de estados unidos

cookies %>% 
  count(browser, sort = TRUE)
```

```{r}
#opcion 1
cookies_us <- cookies %>%
  filter(pais == "United States") %>%
  group_by(browser, dispositivo) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop")

cookies_us_tot <- cookies %>%
  filter(pais == "United States") %>%
  group_by(browser) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop") %>%
  mutate(dispositivo = "Total navegador")  # para identificar la fila total

cookies_treemap <- bind_rows(cookies_us, cookies_us_tot)

cookies_treemap <- cookies_treemap %>%
  mutate(etiqueta = ifelse(dispositivo == "Total navegador",
                           browser,
                           paste0(dispositivo, "-", browser)))

plot_ly(
  data = cookies_treemap,
  type = "treemap",
  labels = ~etiqueta,
  parents = ~ifelse(dispositivo == "Total navegador", "", browser),
  values = ~tiempo_total,
  textinfo = "label+value+percent parent+percent root",
  hoverinfo = "label+value+percent parent") |> 
  add_trace(branchvalues = "total", name = "")
```

```{r}
# opcion 2
cookies_us <- cookies %>%
  group_by(browser, dispositivo) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop")

cookies_us_tot <- cookies %>%
  group_by(browser) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop") %>%
  mutate(dispositivo = "Total navegador")  # para identificar la fila total

cookies_treemap <- bind_rows(cookies_us, cookies_us_tot)

cookies_treemap <- cookies_treemap %>%
  mutate(etiqueta = ifelse(dispositivo == "Total navegador",
                           browser,
                           paste0(dispositivo, "-", browser)))

plot_ly(
  data = cookies_treemap,
  type = "treemap",
  labels = ~etiqueta,
  parents = ~ifelse(dispositivo == "Total navegador", "", browser),
  values = ~tiempo_total,
  textinfo = "label+value+percent parent+percent root",
  hoverinfo = "label+value+percent parent") |> 
  add_trace(branchvalues = "total", name = "")
```