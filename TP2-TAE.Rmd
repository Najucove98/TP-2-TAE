---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerias usadas
library(tidyverse) #Solo poner las librerias que usemos

# Carga de los datos
cookies <- read.delim("cookies.txt")

# Exploración de los datos
summary(cookies)
```
# Introducción


Datos: Google Analytics
Los datos a analizar consisten en registros de Google Analytics, herramienta utilizada para hacer
un seguimiento del comportamiento de los usuarios en un sitio web. En particular, esta base
contiene informaci´on sobre visitas al sitio de compras online https://shop.merch.google/
durante el primer semestre del a˜no 2017. La base se encuentra almacenada en el archivo
cookies.txt y contiene las siguientes variables.
 ID: n´umero que identifica a cada visitante del sitio web.
 fecha: fecha de la visita al sitio web.
 clicks: cantidad de clicks realizados durante la visita al sitio web.
 paginas: cantidad de p´aginas accedidas durante la visita al sitio web.
 tiempo: duraci´on de la visita al sitio web, en segundos.
 gasto: valor monetario de las compras realizadas durante la visita al sitio web, en d´olares.
 browser: tipo de navegador desde el que accedi´o al sitio web.
 dispositivo: tipo de dispositivo desde el que accedi´o al sitio web.
 pais: pa´ıs de residencia del visitante del sitio web.

Consigna
El objetivo de este TP es poner en pr´actica habilidades para la confecci´on de reportes orientados
al an´alisis exploratorio de datos, en particular, mediante las herramientas R Markdown o
Quarto. El reporte debe ser entregado en formato .html o .pdf, junto con el script de
codigo .Rmd o .qmd utilizado. Cada informe deber´a plantear 4 interrogantes, los cuales ser´an
analizados mediante gr´aficos y tablas. 






```{r}
n_visitas <- nrow(cookies)
n_compras <- nrow(filter(cookies, gasto > 0))

```
Trabajamos sobre estados unidos? justificarlo

```{r} 
# Datos de estados unidos

cookies_eeuu <- filter(cookies, pais == "United States")

summary(cookies_eeuu)

nrow(cookies_eeuu)
```


# Objetivo 1

```{r}
#Posible interrogante
# Ver la evolucion de la cantidad de compras a lo largo de los meses
# Ver la evoluxion de compras en dias especiales
# ver la evolucion de compras a lo largo del mes

datos_gastos <- filter(cookies, gasto > 0)

datos_gastos %>% 
  count(pais, sort = TRUE)

# 5277 observaciones del total hicieron compras 
#dim(datos_gastos)
```

```{r}
library(echarts4r) # crea gráficos interactivos
library(gapminder) # una base de datos de estadísticas demográficas.
library(plotly)

#---------------------------------------------------------------------------------------------------

filtrado <- gapminder %>% 
  mutate(pobl = pop / 1000000) %>% # Crea/modifica la columna 'pobl' (población) dividiendo la columna 'pop' (población) por un millón (1,000,000) para expresarla en millones.
  filter(                  # Filtra las filas del dataset.
    country %in% c("Argentina", "Brazil", "Colombia", "Ecuador", "Chile", # Mantiene solo las filas donde el país ('country') está en el vector de países sudamericanos especificados.
                   "Paraguay", "Bolivia", "Peru", "Uruguay", "Venezuela") # Continúa el vector de países.
  )

#---------------------------------------------------------------------------------------------------

#crea un grafico estatico con los datos de interes
serie_sudam <- ggplot(data = filtrado) + # Inicia la construcción de un gráfico estático de 'ggplot2' (asignado a 'serie_sudam') usando el dataset 'filtrado'.
  aes(x = year, y = pobl, color = country) + # Define las 'estéticas' (mapeos visuales): 'year' para el eje X, 'pobl' (población en millones) para el eje Y, y 'country' para el color de las líneas.
  geom_line(linewidth = 1) + # Añade una capa de líneas (gráfico de líneas de tiempo), con un grosor de 1.
  geom_point(size = 2) + # Añade una capa de puntos sobre las líneas, con un tamaño de 2.
  scale_x_continuous(breaks = seq(1952, 2007, 5)) + # Personaliza el eje X: establece saltos cada 5 años, desde 1952 hasta 2007.
  scale_y_continuous(breaks = seq(0, 200, 50), limits = c(0, 200)) + # Personaliza el eje Y: establece saltos de 50 en 50, con límites de 0 a 200.
  labs(x = "Año", y = "Población (en millones)", # Define las etiquetas de los ejes X e Y.
       title = "Evolución de la población de los países sudamericanos") + # Define el título principal del gráfico.
  theme_bw() # Aplica un tema de fondo blanco y rejilla para una apariencia limpia.

#---------------------------------------------------------------------------------------------------

#se usa para hacer interactivo el grafico
ggplotly(serie_sudam)

#---------------------------------------------------------------------------------------------------

#una mejor visualizacion del grafico anterior
filtrado %>%
  group_by(country) %>% # Agrupa los datos por 'country' (país). *Esto es un requisito para que 'e_charts' dibuje series separadas por país.*
  e_charts(x = year) %>% # Inicia la creación de un gráfico interactivo con 'echarts4r', mapeando 'year' al eje X.
  e_line(serie = pobl) %>% # Añade un gráfico de líneas, usando 'pobl' (población en millones) como los valores de la serie (eje Y).
  e_title("Evolución de la población de los países sudamericanos") %>% # Define el título del gráfico interactivo.
  e_x_axis(name = "Año", serie = year) %>% # Define el nombre del eje X como "Año" y usa la columna 'year' como datos.
  e_y_axis(name = "Población (en millones)") %>% # Define el nombre del eje Y como "Población (en millones)".
  e_legend(orient = "vertical", left = "10%", top = "10%") %>% # Personaliza la leyenda: orientación vertical, posicionada al 10% desde la izquierda y 10% desde arriba.
  e_tooltip(trigger = "axis") # Configura las tooltips (información emergente al pasar el ratón) para que se muestre al pasar sobre el eje X.
```



# Objetivo 2 

```{r}
#Posible interrogante
# Ver proporcion de individuos q usan distintos navegadores 
# Ver su relacion con los gastos o con los gastos de estados unidos

# grafico de barras para los dispositivos dentro de la base de estados unidos
cookies %>% 
  count(dispositivo, sort = TRUE)

# grafico de barras para los navegadores dentro de la base de estados unidos

cookies %>% 
  count(browser, sort = TRUE)
```

# Objetivo 3

Interrogante: ¿Los usuarios que tienen mas paginas/clicks/tiempo accedidas tienden a realizar gastos mas grandes?

```{r}
# Filtrar los datos para individuos con un tiempo de duracion de la visitia al sitio web > 1 (esto elimina valores con clicks = 1 y valores con paginas = 1)

# Grafico de dispersion para ver si hay relacion entre las variables clicks y gasto
# dentro de la base que si gastaron
# comparar con la alternativa : graf de dispersion entre paginas y gasto
```

# Objetivo 4 
utilizar la variable dispositivo para ver relaciones con otras variables

```{r}
table(cookies$browser, cookies$dispositivo)
```

# Objetivo 5 

Los visitantes frecuentes muestran un gasto mayor o menor que los visitantes unicos (subgrupos de visitantes frecuentes, ¿ == 1 o > 1 ? ) ver como queda por promedio o total, grafico de barras

Ver la relacion entre un usuario mas frecuente gasta mas en la pagina (grafico de dispersion)

```{r}
datos_gastos %>% 
  count(ID, sort = TRUE)


# Contar cuántas visitas hizo cada ID
visitas_por_id <- datos_gastos %>%
  group_by(ID) %>%
  summarise(n_visitas = n(),
            gasto_total = sum(gasto),
            gasto_promedio = mean(gasto))
```

# Objetivo 6

```{r}
# El uso de las tablas dinamicas requiere un procesamiento de los datos

santafe <- cultivos %>% 
  filter(
    prov == "SANTA FE", 
    campaña == "2019/20",
    !cultivo %in% c("Soja 1ra", "Soja 2da")
    ) %>% 
  group_by(cultivo) %>% 
  summarise(prod = sum(prod, na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(desc(prod))




#Idea con Tablas dinamicas Treemaps
library(plotly)

plot_ly(
  type = "treemap",
  labels = santafe$cultivo,
  parents = "", 
  values = santafe$prod
  )

```

```{r}
# El uso de las tablas dinamicas requiere un procesamiento de los datos
depto_cultivos <- deptos %>%
  filter(                  # Filtra las filas del dataset 'deptos'.
    prov == "SANTA FE",    # Mantiene solo las filas donde la provincia (prov) es "SANTA FE".
    campana == "2019/20",  # Mantiene solo las filas donde la campaña (campana) es "2019/20".
    !cultivo %in% c("Soja 1ra", "Soja 2da") # Mantiene solo las filas donde el cultivo NO está en el vector (es decir, excluye "Soja 1ra" y "Soja 2da").
  ) %>%
  group_by(depto, cultivo) %>% # Agrupa los datos por 'depto' (departamento) y 'cultivo'.
  summarise(               # Calcula valores resumen por cada grupo creado.
    prod = sum(prod, na.rm = TRUE), # Calcula la suma de la columna 'prod' (producción) para cada grupo, ignorando NAs.
    .groups = "drop"       # Indica que se debe eliminar la agrupación después de calcular el resumen.
  )

#---------------------------------------------------------------------------------------------------

deptos_tot <- deptos_cultivos %>% 
  #Calculo totales por depto
  group_by(depto) %>%          # Agrupa los datos ÚNICAMENTE por 'depto' (departamento).
  summarise(prod = sum(prod, na.rm = TRUE)) %>% # Calcula la suma de 'prod' (producción) por cada departamento.
  ungroup() %>%                # Elimina la agrupación para que las siguientes operaciones afecten a todo el dataset.
  rename(cultivo = depto) %>%  # Renombra la columna 'depto' a 'cultivo' (es una preparación para el siguiente paso, donde 'cultivo' representará el total del departamento).
  mutate(depto = "Total Santa Fe") # Crea/modifica la columna 'depto' y asigna el valor fijo "Total Santa Fe" a todas las filas (esto convierte cada fila en el total de un depto bajo una nueva categoría de "Total Santa Fe").

#---------------------------------------------------------------------------------------------------

#Uno con el dataset original
deptos_tot <- bind_rows(deptos_cultivos, deptos_tot) # Combina (apila) las filas del dataset original 'deptos_cultivos' con el de totales 'deptos_tot'.

#---------------------------------------------------------------------------------------------------

#Genero etiquetas únicas
deptos_tot <- deptos_tot %>% # Continúa usando el dataset combinado.
  mutate(etiq = ifelse(depto != "Total Santa Fe", # Crea/modifica la columna 'etiq' (etiqueta).
                       paste0(cultivo, "-", depto), # Si 'depto' NO es "Total Santa Fe", la etiqueta es "cultivo-depto" (ej: Maiz-Rosario).
                       cultivo)) # Si 'depto' ES "Total Santa Fe", la etiqueta es solo el 'cultivo' (que en este caso es el total del departamento renombrado previamente).

#---------------------------------------------------------------------------------------------------

#Idea con Tablas dinamicas Treemaps
# Inicia la creación de un gráfico interactivo con plotly, utilizando el dataset 'deptos_tot'.
plot_ly(deptos_tot, 
        type = 'treemap',        # Especifica el tipo de gráfico como 'treemap'.
        labels = ~etiq,          # Usa la columna 'etiq' (etiqueta única) para las etiquetas de los rectángulos (jerarquía menor).
        parents = ~deptos_tot$depto, # Usa la columna 'depto' para la jerarquía superior/padre de los rectángulos.
        values = ~deptos_tot$prod,   # Usa la columna 'prod' (producción) para el tamaño de cada rectángulo.
        hoverinfo = "text",      # Muestra la información de 'text' al pasar el ratón.
        textinfo = "label+value+percent parent+percent root", # Muestra en el gráfico la etiqueta, valor, porcentaje respecto al padre y porcentaje respecto al total.
        add_trace(branchvalues = "total", name = "") # Ajusta cómo se calculan los nodos del treemap y añade la traza al gráfico.
)
```
```{r}
library(highcharter)
library(quantmod)

amazon <- getSymbols("AMZN", auto.assign = FALSE)

hchart(amazon, type = "ohlc") %>% 
  hc_title(text = "Serie temporal: datos OHLC para Amazon") %>%  
  hc_add_theme(hc_theme_bloom())
```

