---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerías para manipular los datos
library(dplyr)
library(lubridate)
library(countrycode)

# Librerías para graficar
library(ggplot2)
library(leaflet.extras) # Mapa
library(echarts4r) # Linea temporal 
library(plotly) # Gráfico de dispersión y treemap

# Base de datos con los polígonos para hacer mapa
library(rnaturalearth)

# Para control de titulos
library(htmltools)

# Elimina la notación cientifica
options(scipen = 999)

# Carga de los datos
cookies <- read.delim("cookies.txt")
```
# Introducción

Se cuenta con la base de datos de un sitio web de compras online ([shop.merch.google](https://shop.merch.google/)), con el fin de encontrar distintas relaciones entre las variables provistas, se procede a hacer un análisis descriptivo de las visitas al sitio web para responder distintas interrogantes.

La base de datos original contiene variables clave como:

- ID: número que identifica a cada visitante del sitio web.
- fecha: fecha de la visita al sitio web.
- clicks: cantidad de clicks realizados durante la visita al sitio web.
- paginas: cantidad de páginas accedidas durante la visita al sitio web.
- tiempo: duración de la visita al sitio web, en segundos.
- gasto: valor monetario de las compras realizadas durante la visita al sitio web, en dólares.
- browser: tipo de navegador desde el que accedió al sitio web.
- dispositivo: tipo de dispositivo desde el que accedió al sitio web.
- pais: país de residencia del visitante del sitio web.

## ¿La distribución geográfica de las visitas refleja una concentración marcada en determinado país?

```{r}
# Uso de la librería "countrycode" para codificar los países
# Agrupación de la base por países y cálculo de las estadísticas de interés
cookies_paises <- cookies |> 
  mutate(country = countrycode(
    sourcevar = pais,
    origin = "country.name.en",
    destination = "iso2c",
    nomatch = NA_character_)) |> 
  filter(!is.na(country)) |> 
  group_by(country, pais) |> 
  summarise(Total_Visitas = n(),
            Total_Usuarios = n_distinct(ID))

# Creación de la base con las cordenadas de los poligonos de cada pais
mapa_datos <- ne_countries(scale = "medium",returnclass = "sf") |> 
  select(iso_a2, geometry) |> 
  left_join(cookies_paises, by = c("iso_a2" = "country")) |> 
  filter(!is.na(Total_Visitas))

# Paleta de colores a utilizar
paleta_colores <- colorNumeric(
  palette = "YlOrRd",
  domain = mapa_datos$Total_Visitas)

# Generacion del mapa con la libreria leaflet
mapa_datos |> 
  leaflet() |> 
  setView(lng = 0, lat = 20, zoom = 1) |> 
  addProviderTiles('OpenStreetMap.Mapnik') |>
  addPolygons(
    fillColor = ~paleta_colores(Total_Visitas),
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "1",
    fillOpacity = 0.7,
    popup = ~paste0("País: ", pais, 
                    "<br>Total Visitas: ", Total_Visitas, 
                    "<br>Total Usuarios: ", Total_Usuarios)) |>
  addLegend(
    pal = paleta_colores,
    values = ~Total_Visitas,
    opacity = 0.6,
    title = "Total de Visitas",
    position = "bottomright") |> 
  addControl(
    html = tags$div(
      style = "font-size: 20px; 
               font-weight: bold; 
               background-color: white; 
               padding: 6px; 
               border-radius: 4px;",
              "Distribución Geográfica del Total de Visitas"), 
      position = "topright")
```
<br>
El mapa muestra la distribución geográfica del total de visitas al sitio web durante el período analizado (Enero-Junio de 2017). Se observa una marcada concentración en **Estados Unidos** (EE. UU), país que registra un volumen de accesos significativamente superior al resto del mundo.

**Estados Unidos** alcanza un total de 172,200 visitas registradas, siendo más de 6 veces el número de visitas del segundo país más relevante, **India**, que cuenta con 24,359 visitas. Esta concentración podría ocasionar una fuerte dependencia comercial con el mercado estadounidense.

Debido a esto, se recomienda una expansión a nivel internacional de la página web para que, de esta manera, se amplíe la base de clientes potenciales.

## ¿Cómo se distribuyó el gasto total semanalmente, y qué diferencia se observa entre el gasto de Estados Unidos y el del resto de países?

```{r}
# Creacion de la base para la linea temporal
datos_tiempo <- cookies |>
  mutate(grupo = ifelse(pais == "United States", "Estados Unidos", "Otros"),
         fecha = ymd(as.character(fecha)),
         semana = floor_date(fecha, unit = "week")) |> 
  group_by(semana, grupo) |>
  summarise(gasto_semanal = sum(gasto, na.rm = TRUE), .groups = "drop")

# Creacion de la linea temporal por semana
datos_tiempo |> 
  group_by(grupo) |>  
  e_charts(x = semana) |>
  e_line(serie = gasto_semanal) |>
  e_title("Evolución semanal del gasto total") |> 
  e_x_axis(name = "Semana", serie = semana) |> 
  e_y_axis(name = "Gasto (en USD)") |> 
  e_legend(orient = "vertical", left = "10%", top = "10%")  |> 
  e_tooltip(trigger = "axis")
```

La línea temporal muestra la evolución semanal del gasto total en el sitio web, diferenciando a **Estados Unidos** (EE. UU.) del resto de los países.

Se puede observar que el gasto realizado en **Estados Unidos** es ampliamente superior en el periodo de tiempo analizado, además de presentar picos mucho más marcados en la temporada Abril-Mayo de 2017.

El gasto total del resto de países (sin considerar a **Estados Unidos**) a lo largo del periodo analizado presenta picos que se encuentran distribuidos uniformemente a lo largo de los meses, sin ninguna concentración en algún mes en particular.

## ¿La cantidad de visitas donde se efectuo una compra esta relacionado con el gasto promedio por usuario?

```{r}
# Creación de la base de datos por visita donde se realizó una compra de los usuarios
visitas_por_id <- cookies |> 
  filter(gasto > 0) |> 
  group_by(ID) |> 
  summarise(n_visitas_efectivas = n(),
            gasto = mean(gasto),
            tiempo = mean(tiempo),
            clicks = mean(clicks),
            paginas = mean(paginas))

# Gráfico de dispersión de los valores promedio del gasto por usuario vs número de visitas efectivas
grafico <- ggplot(data = visitas_por_id) +
  aes(x = n_visitas_efectivas, 
      y = gasto,
      text = paste0(
        "<b>Nº de Visitas Efectivas: </b>", n_visitas_efectivas, "<br>",
        "<b>Gasto Promedio: </b>", round(gasto, 2), " USD <br>",
        "<b>Tiempo promedio: </b>", round(tiempo/60, 2), " min <br>",
        "<b>Clicks promedio: </b>", round(clicks), "<br>",
        "<b>Paginas promedio: </b>", round(paginas))) +
  geom_point() +
  labs(x = "Nº de Visitas Efectivas",
       y = "Gasto Promedio por Visita (USD)",
       title = "Relación Gasto Promedio vs. Frecuencia de Compra") +
  theme_bw()

# Gráfico de dispersión dinámico con la librería plotly
ggplotly(grafico + 
           scale_x_continuous(breaks = seq(0, 30, 5)) +
           scale_y_continuous(breaks = seq(0, 8000, 1000)), 
         tooltip = "text")
```
<br>
El gráfico describe la relación entre el número de visitas efectivas (donde se efectuó una compra) y el gasto promedio por usuario. Se puede observar la presencia de dos usuarios con valores atípicos (outliers) que se alejan del comportamiento de la mayoría, por lo cual se procede a visualizar el grupo de usuarios sin estos datos atípicos.

```{r}
# Gráfico de dispersión dinámico con zoom sin considerar los valores atipicos
ggplotly(grafico +
           coord_cartesian(xlim = c(0.3, 10), ylim = c(0, 7000)) +
           scale_x_continuous(breaks = seq(0, 10, 1)) +
           scale_y_continuous(breaks = seq(0, 7000, 1000)), 
         tooltip = "text")
```
<br>
En el gráfico podemos observar que la tendencia en el gasto promedio por visita de los usuarios disminuye a medida que aumenta el número de visitas efectivas (compras).

Podemos destacar que:

- Los usuarios con compras únicas (1 visita efectiva) tienen la mayor dispersión en su gasto promedio, alcanzando los valores más altos (7000 USD).

- Los usuarios con más visitas efectivas (mayor frecuencia de compra) tienden a concentrar la variabilidad del gasto promedio en un rango mucho menor (alrededor de 1,000 USD o menos).

## ¿Qué tiempo de permanencia tienen los usuarios según el navegador y el dispositivo que usa?

```{r}
# Creación de la base de datos sobre navegador y dispositivos
cookies_navegador <- cookies |> 
  group_by(browser, dispositivo) |> 
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE)/60, .groups = "drop") |> 
  mutate(
    dispositivo = case_when(
      dispositivo == "desktop" ~ "Escritorio",
      dispositivo == "mobile"  ~ "Móvil",
      dispositivo == "tablet"  ~ "Tablet"))

# Creación de la base de datos para utilizar en el treemap
cookies_treemap <- cookies_navegador |> 
  group_by(browser) |> 
  summarise(tiempo_total = sum(tiempo_total, na.rm = TRUE)) |> 
  ungroup() |> 
  rename(dispositivo = browser) |> 
  mutate(browser = "Tiempo total (minutos)") |> 
  bind_rows(cookies_navegador) |> 
  mutate(etiqueta = ifelse(browser != "Tiempo total (minutos)", paste0(dispositivo, " - ", browser), dispositivo))

# Creación del treemap
cookies_treemap |> 
  plot_ly(
    type = "treemap",
    labels = ~etiqueta,
    parents = ~ifelse(dispositivo == "Tiempo total (minutos)", "", browser),
    values = ~tiempo_total,
    hoverinfo = "label+value+percent parent+percent root",
    textinfo = "label+value+percent parent+percent root") |> 
  layout(
    title = list(
      text = "Distribución del Tiempo total por Navegador y Dispositivo",
      font = list(size = 18))) |> 
  add_trace(branchvalues = "total", name = "")
```

En el gráfico podemos observar la distribución del tiempo total de permanencia (en minutos) de todas las visitas, segmentado por navegador web y tipo de dispositivo.

El navegador más utilizado en el sitio web es **Chrome**, cuyo tiempo total representa el 78% entre todos los navegadores. Dentro de Chrome, el 83% del tiempo total de este navegador corresponde a usuarios con dispositivos de **escritorio** (desktop).

En segundo lugar, el navegador **Safari** concentra el 14% del tiempo total entre todos los navegadores. En este caso, el dispositivo más utilizado es el **móvil**, representando el 57% del tiempo total de uso de Safari.