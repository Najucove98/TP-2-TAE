---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerias usadas
library(tidyverse) #Solo poner las librerias que usemos
library(readxl)

# Carga de los datos
cookies <- read.delim("cookies.txt")

# Exploración de los datos
summary(cookies)
```
# Introducción


Datos: Google Analytics
Los datos a analizar consisten en registros de Google Analytics, herramienta utilizada para hacer
un seguimiento del comportamiento de los usuarios en un sitio web. En particular, esta base
contiene informaci´on sobre visitas al sitio de compras online https://shop.merch.google/
durante el primer semestre del a˜no 2017. La base se encuentra almacenada en el archivo
cookies.txt y contiene las siguientes variables.
 ID: n´umero que identifica a cada visitante del sitio web.
 fecha: fecha de la visita al sitio web.
 clicks: cantidad de clicks realizados durante la visita al sitio web.
 paginas: cantidad de p´aginas accedidas durante la visita al sitio web.
 tiempo: duraci´on de la visita al sitio web, en segundos.
 gasto: valor monetario de las compras realizadas durante la visita al sitio web, en d´olares.
 browser: tipo de navegador desde el que accedi´o al sitio web.
 dispositivo: tipo de dispositivo desde el que accedi´o al sitio web.
 pais: pa´ıs de residencia del visitante del sitio web.

Consigna
El objetivo de este TP es poner en pr´actica habilidades para la confecci´on de reportes orientados
al an´alisis exploratorio de datos, en particular, mediante las herramientas R Markdown o
Quarto. El reporte debe ser entregado en formato .html o .pdf, junto con el script de
codigo .Rmd o .qmd utilizado. Cada informe deber´a plantear 4 interrogantes, los cuales ser´an
analizados mediante gr´aficos y tablas. 




##Objetivo 1 (grafico de geolocalizacion)

```{r}
library(leaflet.extras) #para crear el mapa de calor

library(countrycode) #para codificar los paises

# Para obtener los poligonos de cada pais
library(rnaturalearth)
library(sf)

datos_poligono <- datos_validos %>%
  filter(!is.na(country)) %>%
  group_by(country, pais) %>%
  summarise(Total_Visitas = n())



limites_mundiales <- ne_countries(scale = "medium", returnclass = "sf") %>%
  select(iso_a2, geometry)

# 1. Unir los datos agregados con los límites geográficos
#    La unión se realiza por el código ISO de 2 letras (iso_a2 en el mapa, country en tus datos)
mapa_datos <- limites_mundiales %>%
  left_join(datos_poligono, by = c("iso_a2" = "country")) %>%
  # Filtrar para dejar solo los países que tienen visitas (Total_Visitas > 0 o no NA)
  filter(!is.na(Total_Visitas))

# 2. Definir la paleta de colores (más visitas = rojo más oscuro)
paleta_colores <- colorNumeric(
  palette = "YlOrRd", # paletas usadas Blues, Reds, viridis, magma, YlOrRd
  domain = mapa_datos$Total_Visitas,
  n = 7
)


# 3. Generar el Mapa Coroplético
mapa_datos %>%
  leaflet() %>%
  addProviderTiles('OpenStreetMap') %>% # addProviderTiles("NASAGIBS.ViirsEarthAtNight2012")
  addPolygons(
    fillColor = ~paleta_colores(Total_Visitas), # Colorea según la variable Total_Visitas
    weight = 1, # Grosor de las fronteras
    opacity = 1,
    color = "grey", # Color de las fronteras
    dashArray = "3",
    fillOpacity = 0.8, # Transparencia del color
    # Agrega un PopUp para mostrar el total de visitas al hacer clic
    popup = ~paste0("País: ", pais, "<br>Total Visitas: ", Total_Visitas)
  ) %>%
  # Agregar la leyenda para interpretar los colores
  addLegend(
    pal = paleta_colores,
    values = ~Total_Visitas,
    opacity = 0.7,
    title = "Total de Visitas",
    position = "bottomright"
  )
```


```{r}
datos_agrupados <- cookies %>%
  mutate(grupo = ifelse(pais == "United States", "Estados Unidos", "Otros"))

gasto_por_grupo <- datos_agrupados |> 
  mutate(gasto_miles = gasto/1000) |> 
  group_by(grupo) %>%
  summarise(gasto_total = sum(gasto_miles, na.rm = TRUE),
            gasto_promedio = mean(gasto_miles, na.rm = TRUE),
            n_visitas = n()) %>%
  arrange(desc(gasto_total))

ggplot(gasto_por_grupo, aes(x = grupo, y = gasto_total, fill = grupo)) +
  geom_bar(stat = "identity") +
  labs(title = "Gasto total: Estados Unidos vs. Otros países",
       x = "", y = "Gasto total (USD x miles)") +
  theme_minimal() +
  theme(legend.position = "none")
```



```{r} 
# Datos de estados unidos

cookies_eeuu <- filter(cookies, pais == "United States")

summary(cookies)

```

## Objetivo 2 (linea de tiempo sobre el gasto de estados unidos vs otros)

```{r}
library(echarts4r)
#Posible interrogante
# Ver la evolucion de la cantidad de compras a lo largo de los meses
# Ver la evoluxion de compras en dias especiales
# ver la evolucion de compras a lo largo del mes

cookies_fecha <- datos_agrupados |>  
  mutate(fecha = as.Date(as.character(fecha), format = "%Y%m%d"))

cookies_dispositivos_diarios <- cookies_fecha |> 
  group_by(fecha, grupo) |> 
  summarise(gasto_dia = sum(gasto, na.rm = TRUE))

#una mejor visualizacion del grafico anterior
cookies_dispositivos_diarios %>%
  group_by(grupo) %>% # Agrupa los datos por 'country' (país).
  e_charts(x = fecha) %>% # mapeando 'year' al eje X.
  e_line(serie = gasto_dia) %>% # usa 'pobl' como los valores de la serie (eje Y).
  e_title("Evolución de la población de los países sudamericanos") %>% # Define el título del gráfico interactivo.
  e_x_axis(name = "Dia", serie = fecha) %>% # Define el nombre del eje X y usa la columna 'year' como datos.
  e_y_axis(name = "Gasto (en USD)") %>% # Define el nombre del eje y.
  e_legend(orient = "vertical", left = "10%", top = "10%") %>% # Personaliza la leyenda: orientación vertical, posicionada al 10% desde la izquierda y 10% desde arriba.
  e_tooltip(trigger = "axis") # Configura las tooltips (información emergente al pasar el ratón) para que se muestre al pasar sobre el eje X.

```

Conclusion



# Objetivo 3

idea general visualizar por usuario

```{r}
library(plotly)
usuarios <- cookies |>
  filter(ID != 1957458976293878016, pais == "United States") |> 
  group_by(ID) |> 
  summarise(paginas = sum(paginas, na.rm = TRUE),
            clicks = sum(clicks, na.rm = TRUE),
            tiempo = (sum(tiempo, na.rm = TRUE)/60),
            gasto = sum(gasto, na.rm = T),
            visitas = n()) |> 
  filter(gasto > 0) |> 
  arrange(desc(gasto))

grafico <- ggplot(data = usuarios[1:100, ]) +
  aes(x = visitas, y = tiempo) +
  geom_point()

ggplotly(grafico)

```

```{r}
usuarios_mas <- usuarios[1:100, ]
plot_ly(
  data = usuarios_mas, 
  x = ~visitas, 
  y = ~tiempo, 
  z = ~gasto, 
  type = "scatter3d", 
  mode = "markers", 
  size = I(150),
  hoverinfo = "text",
  hovertext = paste0(
    "<b>Visitas total: </b>", usuarios_mas$visitas, "<br>",
    "<b>Tiempo total: </b>", usuarios_mas$tiempo, "<br>",
    "<b>Gasto total: </b>", usuarios_mas$gasto, "<br>",
    "<b>Paginas total: </b>", usuarios_mas$paginas
  )
  ) %>% 
  layout(
    scene = list(
      xaxis = list(title = "Visitas"),
      yaxis = list(title = "tiempo"),
      zaxis = list(title = "gasto")
      )
  )
```
```{r}
usuarios_menos <- usuarios[4331:4430, ]
plot_ly(
  data = usuarios_menos, 
  x = ~visitas, 
  y = ~tiempo, 
  z = ~gasto, 
  type = "scatter3d", 
  mode = "markers", 
  size = I(150),
  hoverinfo = "text",
  hovertext = paste0(
    "<b>Visitas total: </b>", usuarios_menos$visitas, "<br>",
    "<b>Tiempo total: </b>", usuarios_menos$tiempo, "<br>",
    "<b>Gasto total: </b>", usuarios_menos$gasto, "<br>",
    "<b>Paginas total: </b>", usuarios_menos$paginas
  )
  ) %>% 
  layout(
    scene = list(
      xaxis = list(title = "Visitas"),
      yaxis = list(title = "tiempo"),
      zaxis = list(title = "gasto")
      )
  )
```
```{r}
usuarios_extremos <- rbind(usuarios_mas, usuarios_menos)
plot_ly(
  data = usuarios_extremos, 
  x = ~visitas, 
  y = ~tiempo, 
  z = ~gasto, 
  type = "scatter3d", 
  mode = "markers", 
  size = I(150),
  hoverinfo = "text",
  hovertext = paste0(
    "<b>Visitas total: </b>", usuarios_extremos$visitas, "<br>",
    "<b>Tiempo total: </b>", usuarios_extremos$tiempo, "<br>",
    "<b>Gasto total: </b>", usuarios_extremos$gasto, "<br>",
    "<b>Paginas total: </b>", usuarios_extremos$paginas
  )
  ) %>% 
  layout(
    scene = list(
      xaxis = list(title = "Visitas"),
      yaxis = list(title = "tiempo"),
      zaxis = list(title = "gasto")
      )
  )
```

# Objetivo 5 alternativa del objetivo 3


Los visitantes frecuentes muestran un gasto mayor o menor que los visitantes unicos (subgrupos de visitantes frecuentes, ¿ == 1 o > 1 ? ) ver como queda por promedio, grafico de barras

Ver la relacion entre un usuario mas frecuente gasta mas en la pagina (grafico de dispersion)

```{r}
datos_gastos <- cookies |> 
  filter(gasto > 0, ID != 1957458976293878016)
  


# Contar cuántas visitas hizo cada ID
visitas_por_id <- datos_gastos %>%
  group_by(ID) %>%
  summarise(n_visitas_efectivas = n(),
            gasto_total = sum(gasto),
            tiempo_total = sum(tiempo),
            clicks_total = sum(clicks),
            paginas_total = sum(paginas))

datos_visita_unica <- visitas_por_id |> 
  filter(tiempo_total != "is.na") |> 
  group_by(n_visitas_efectivas) |> 
  summarise(gasto_promedio = mean(gasto_total),
            tiempo_promedio = mean(tiempo_total),
            clicks_promedio = mean(clicks_total),
            paginas_promedio = mean(paginas_total))

plot_ly(
  data = datos_visita_unica, 
  x = ~n_visitas_efectivas, 
  y = ~tiempo_promedio, 
  z = ~gasto_promedio, 
  type = "scatter3d", 
  mode = "markers", 
  size = I(150),
  hoverinfo = "text",
  hovertext = paste0(
    "<b>Visitas unicas: </b>", datos_visita_unica$n_visitas_efectivas, "<br>",
    "<b>Tiempo promedio: </b>", datos_visita_unica$tiempo_promedio, "<br>",
    "<b>Gasto promedio: </b>", datos_visita_unica$gasto_promedio, "<br>",
    "<b>Paginas promedio: </b>", datos_visita_unica$paginas_promedio
  )
  ) %>% 
  layout(
    scene = list(
      xaxis = list(title = "Visitas"),
      yaxis = list(title = "tiempo"),
      zaxis = list(title = "gasto")
      )
  )
```




## Objetivo 3

```{r}
# El uso de las tablas dinamicas requiere un procesamiento de los datos

deptos <- cultivos %>%
  filter(                  # Filtra las filas del dataset 'deptos'.
    prov == "SANTA FE",    # Mantiene solo las filas donde la provincia (prov) es "SANTA FE".
    campaña == "2019/20",  # Mantiene solo las filas donde la campaña (campana) es "2019/20".
    !cultivo %in% c("Soja 1ra", "Soja 2da") # Mantiene solo las filas donde el cultivo NO está en el vector
  ) %>%
  group_by(dpto, cultivo) %>% # Agrupa los datos por 'depto' (departamento) y 'cultivo'.
  summarise(               # Calcula valores resumen por cada grupo creado.
    prod = sum(prod, na.rm = TRUE), # Calcula la suma de la columna 'prod' (producción) para cada grupo, ignorando NAs.
    .groups = "drop"       # Indica que se debe eliminar la agrupación después de calcular el resumen.
  )

#---------------------------------------------------------------------------------------------------

deptos_tot <- deptos %>% 
  #Calculo totales por depto
  group_by(dpto) %>%          # Agrupa los datos ÚNICAMENTE por 'depto' (departamento).
  summarise(prod = sum(prod, na.rm = TRUE)) %>% # Calcula la suma de 'prod' (producción) por cada departamento.
  ungroup() %>%                # Elimina la agrupación para que las siguientes operaciones afecten a todo el dataset.
  rename(cultivo = dpto) %>%  # Renombra la columna 'depto' a 'cultivo' (es una preparación para el siguiente paso, donde 'cultivo' representará el total del departamento).
  mutate(dpto = "Total Santa Fe") # Crea/modifica la columna 'depto' y asigna el valor fijo "Total Santa Fe" a todas las filas (esto convierte cada fila en el total de un depto bajo una nueva categoría de "Total Santa Fe").

#---------------------------------------------------------------------------------------------------

#Uno con el dataset original
deptos_tot <- bind_rows(deptos, deptos_tot) # Combina (apila) las filas del dataset original 'deptos_cultivos' con el de totales 'deptos_tot'.

#---------------------------------------------------------------------------------------------------

#Genero etiquetas únicas
deptos_tot <- deptos_tot %>% # Continúa usando el dataset combinado.
  mutate(etiq = ifelse(dpto != "Total Santa Fe", # Crea/modifica la columna 'etiq' (etiqueta).
                       paste0(cultivo, "-", dpto), # Si 'depto' NO es "Total Santa Fe", la etiqueta es "cultivo-depto" (ej: Maiz-Rosario).
                       cultivo)) # Si 'depto' ES "Total Santa Fe", la etiqueta es solo el 'cultivo' (que en este caso es el total del departamento renombrado previamente).

#---------------------------------------------------------------------------------------------------

#Idea con Tablas dinamicas Treemaps
# Inicia la creación de un gráfico interactivo con plotly, utilizando el dataset 'deptos_tot'.
plot_ly(deptos_tot, 
        type = 'treemap',        # Especifica el tipo de gráfico como 'treemap'.
        labels = ~etiq,          # Usa la columna 'etiq' (etiqueta única) para las etiquetas de los rectángulos (jerarquía menor).
        parents = ~deptos_tot$dpto, # Usa la columna 'depto' para la jerarquía superior/padre de los rectángulos.
        values = ~deptos_tot$prod,   # Usa la columna 'prod' (producción) para el tamaño de cada rectángulo.
        hoverinfo = "text",      # Muestra la información de 'text' al pasar el ratón.
        textinfo = "label+value+percent parent+percent root") |>  # Muestra en el gráfico la etiqueta, valor, porcentaje respecto al padre y porcentaje respecto al total.
        add_trace(branchvalues = "total", name = "") # Ajusta cómo se calculan los nodos del treemap y añade la traza al gráfico.
```

```{r}
#Posible interrogante para agregar al treemap
# Ver proporcion de individuos q usan distintos navegadores 
# Ver su relacion con los gastos o con los gastos de estados unidos

# grafico de barras para los dispositivos dentro de la base de estados unidos
cookies %>% 
  count(dispositivo, sort = TRUE)

# grafico de barras para los navegadores dentro de la base de estados unidos

cookies %>% 
  count(browser, sort = TRUE)
```

```{r}
#opcion 1
cookies_us <- cookies %>%
  filter(pais == "United States") %>%
  group_by(browser, dispositivo) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop")

cookies_us_tot <- cookies %>%
  filter(pais == "United States") %>%
  group_by(browser) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop") %>%
  mutate(dispositivo = "Total navegador")  # para identificar la fila total

cookies_treemap <- bind_rows(cookies_us, cookies_us_tot)

cookies_treemap <- cookies_treemap %>%
  mutate(etiqueta = ifelse(dispositivo == "Total navegador",
                           browser,
                           paste0(dispositivo, "-", browser)))

plot_ly(
  data = cookies_treemap,
  type = "treemap",
  labels = ~etiqueta,
  parents = ~ifelse(dispositivo == "Total navegador", "", browser),
  values = ~tiempo_total,
  textinfo = "label+value+percent parent+percent root",
  hoverinfo = "label+value+percent parent") |> 
  add_trace(branchvalues = "total", name = "")
```

```{r}
# opcion 2
cookies_us <- cookies %>%
  group_by(browser, dispositivo) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop")

cookies_us_tot <- cookies %>%
  group_by(browser) %>%
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE), .groups = "drop") %>%
  mutate(dispositivo = "Total navegador")  # para identificar la fila total

cookies_treemap <- bind_rows(cookies_us, cookies_us_tot)

cookies_treemap <- cookies_treemap %>%
  mutate(etiqueta = ifelse(dispositivo == "Total navegador",
                           browser,
                           paste0(dispositivo, "-", browser)))

plot_ly(
  data = cookies_treemap,
  type = "treemap",
  labels = ~etiqueta,
  parents = ~ifelse(dispositivo == "Total navegador", "", browser),
  values = ~tiempo_total,
  textinfo = "label+value+percent parent+percent root",
  hoverinfo = "label+value+percent parent") |> 
  add_trace(branchvalues = "total", name = "")
```