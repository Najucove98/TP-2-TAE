---
title: "Trabajo Práctico Nº2 - Análisis Exploratorio de Datos"
author: "Nahuel Coveñas - Milena Aranda"
lang: es
editor: source
toc: true
format: 
  html:
    self-contained: true
    df-print: paged
    theme: cerulean
    code-fold: true
knitr:
  opts_chunk: 
    echo: false
    message: false
    warning: false
    fig.align: center
lightbox: true
---

```{r}
# Librerias usadas
#library(tidyverse) #Solo poner las librerias que usemos
library(dplyr) #manipulacion de datos
library(ggplot2) #graficar
#library(readxl) #leectura de archivos
library(lubridate) #manipulacion de datos
library(echarts4r) #grafico linea temporal
library(leaflet.extras) #para crear el mapa de calor
library(countrycode) #para codificar los paises
library(rnaturalearth) # Para obtener los poligonos de cada pais
#library(sf) no usamos
library(plotly)
library(htmltools) # Para control de titulos

# Elimina la notacion cientifica
options(scipen = 999)

# Carga de los datos
cookies <- read.delim("cookies.txt")
```
# Introducción

Este informe presenta un análisis descriptivo de la base de datos de un sitio web de compras online ([shop.merch.google](https://shop.merch.google/)), con el objetivo de encontrar distintas relaciones entre las variables provistas.

La base de datos original contiene variables clave como:

- ID: número que identifica a cada visitante del sitio web.
- fecha: fecha de la visita al sitio web.
- clicks: cantidad de clicks realizados durante la visita al sitio web.
- paginas: cantidad de páginas accedidas durante la visita al sitio web.
- tiempo: duración de la visita al sitio web, en segundos.
- gasto: valor monetario de las compras realizadas durante la visita al sitio web, en dólares.
- browser: tipo de navegador desde el que accedió al sitio web.
- dispositivo: tipo de dispositivo desde el que accedió al sitio web.
- pais: país de residencia del visitante del sitio web.

## ¿La distribución geográfica de las visitas refleja una concentración marcada en determinado país?

```{r}
# Uso de la librería "countrycode" para codificar los países
# Agrupación de la base por países y cálculo de las estadísticas de interés
cookies_paises <- cookies |> 
  mutate(country = countrycode(
    sourcevar = pais,
    origin = "country.name.en",
    destination = "iso2c",
    nomatch = NA_character_)) |> 
  filter(!is.na(country)) |> 
  group_by(country, pais) |> 
  summarise(Total_Visitas = n(),
            Total_Usuarios = n_distinct(ID))

# Creación de la base con las cordenadas de los poligonos de cada pais
mapa_datos <- ne_countries(scale = "medium",returnclass = "sf") |> 
  select(iso_a2, geometry) |> 
  left_join(cookies_paises, by = c("iso_a2" = "country")) |> 
  filter(!is.na(Total_Visitas))

# Paleta de colores a utilizar
paleta_colores <- colorNumeric(
  palette = "YlOrRd",
  domain = mapa_datos$Total_Visitas)

# Generacion del mapa con la libreria leaflet
mapa_datos |> 
  leaflet() |> 
  setView(lng = 0, lat = 20, zoom = 1) |> 
  addProviderTiles('OpenStreetMap.Mapnik') |>
  addPolygons(
    fillColor = ~paleta_colores(Total_Visitas),
    weight = 1,
    opacity = 1,
    color = "grey",
    dashArray = "1",
    fillOpacity = 0.7,
    popup = ~paste0("País: ", pais, 
                    "<br>Total Visitas: ", Total_Visitas, 
                    "<br>Total Usuarios: ", Total_Usuarios)) |>
  addLegend(
    pal = paleta_colores,
    values = ~Total_Visitas,
    opacity = 0.6,
    title = "Total de Visitas",
    position = "bottomright") |> 
  addControl(
    html = tags$div(
      style = "font-size: 20px; 
               font-weight: bold; 
               background-color: white; 
               padding: 6px; 
               border-radius: 4px;",
              "Distribución Geográfica del Total de Visitas"), 
      position = "topright")



```

El mapa muestra la distribución geográfica del total de visitas al sitio web durante el período analizado. Se observa una marcada concentración en Estados Unidos, país que registra un volumen de accesos significativamente superior al resto del mundo, lo cual podria ocasinar una fuerte dependencia comercial con el mercado estadounidense. 

Debido a esto, podría recomendarse una expasión a nivel internacional de la página web para que de esta manera se amplie la base de clientes potenciales.

## ¿Cómo evolucionó la cantidad de compras a lo largo de las semanas analizadas?

```{r}
# Creacion de la base para la linea temporal
datos_tiempo <- cookies |>
  mutate(grupo = ifelse(pais == "United States", "Estados Unidos", "Otros"),
         fecha = ymd(as.character(fecha)),
         semana = floor_date(fecha, unit = "week")) |> 
  group_by(semana, grupo) |>
  summarise(gasto_semanal = sum(gasto, na.rm = TRUE), .groups = "drop")

# Creacion de la linea temporal por semana
datos_tiempo |> 
  group_by(grupo) |>  
  e_charts(x = semana) |>
  e_line(serie = gasto_semanal) |>
  e_title("Evolución semanal del gasto total") |> 
  e_x_axis(name = "Semana", serie = semana) |> 
  e_y_axis(name = "Gasto (en USD)") |> 
  e_legend(orient = "vertical", left = "10%", top = "10%")  |> 
  e_tooltip(trigger = "axis")
```

El gráfico muestra la evolución semanal del gasto total en el sitio web, diferenciando a Estados Unidos del resto de los paises. 
Se puede observar que el gasto realizado en Estados unidos es ampliamente superior en el periodo de tiempo analizado, ademas de  presentar picos muchos mas marcados en la temporada Abril-Mayo.

El gasto de los demás paises es plano con respecto a Estados Unidos.Esto reafirma lo mencionado en el gráfico anterior, que la actividad económica del sitio se encuentra reducida a este país particular. Los picos se encuentran distribuidos uniformemente a lo largo de los meses. 

## ¿La cantidad de visitas donde se efectuo una compra esta relacionado con el gasto promedio por usuario?

```{r}
# Creación de la base de datos por visita donde se realizó una compra de los usuarios
visitas_por_id <- cookies |> 
  filter(gasto > 0) |> 
  group_by(ID) |> 
  summarise(n_visitas_efectivas = n(),
            gasto = mean(gasto),
            tiempo = mean(tiempo),
            clicks = mean(clicks),
            paginas = mean(paginas))

# Gráfico de dispersión de los valores promedio del gasto por usuario vs número de visitas efectivas
grafico <- ggplot(data = visitas_por_id) +
  aes(x = n_visitas_efectivas, 
      y = gasto,
      text = paste0(
        "<b>Visitas efectivas: </b>", n_visitas_efectivas, "<br>",
        "<b>Gasto promedio: </b>", round(gasto, 2), " USD <br>",
        "<b>Tiempo promedio: </b>", round(tiempo, 2), " min <br>",
        "<b>Clicks promedio: </b>", round(clicks), "<br>",
        "<b>Paginas promedio: </b>", round(paginas))) +
  geom_point() +
  labs(x = "Visitas efectivas",
       y = "Gasto promedio",
       title = "Relación Visitas efectivas vs. Gasto promedio") +
  theme_bw()

# Gráfico de dispersión dinámico con la librería plotly
ggplotly(grafico + 
           scale_x_continuous(breaks = seq(0, 30, 5)) +
           scale_y_continuous(breaks = seq(0, 8000, 1000)), 
         tooltip = "text")
```

El grafico describe la relacion entre el numero de visitas efectivas y el gasto promedio por usuario donde se observa dos valores atipicos. Por lo cual procedemos a visualizar la mayor concentracion de usuarios.

```{r}
# Gráfico de dispersión dinámico con zoom sin considerar los valores atipicos
ggplotly(grafico +
           coord_cartesian(xlim = c(0.3, 10), ylim = c(0, 7000)) +
           scale_x_continuous(breaks = seq(0, 10, 1)) +
           scale_y_continuous(breaks = seq(0, 7000, 1000)), 
         tooltip = "text")
```

En el grafico podemos observar que la tendencia del numero de visitas donde se efectuo una compra tiende a disminuir en el promedio del gasto por usuario. Podemos destacar que los usuarios con compras unicas tienen una mayor dispersion sobre su gasto y que la relacion entre mas visitas efectivas y el gasto promedio es inversa a la esperada.

## ¿Que tiempo de permanencia tienen los usuarios segun el navegador y el dispositivo que usa?

```{r}
# Creación de la base de datos sobre navegador y dispositivos
cookies_navegador <- cookies |> 
  group_by(browser, dispositivo) |> 
  summarise(tiempo_total = sum(tiempo, na.rm = TRUE)/60, .groups = "drop") |> 
  mutate(
    dispositivo = case_when(
      dispositivo == "desktop" ~ "Escritorio",
      dispositivo == "mobile"  ~ "Móvil",
      dispositivo == "tablet"  ~ "Tablet"))

# Creación de la base de datos para utilizar en el treemap
cookies_treemap <- cookies_navegador |> 
  group_by(browser) |> 
  summarise(tiempo_total = sum(tiempo_total, na.rm = TRUE)/60) |> 
  ungroup() |> 
  rename(dispositivo = browser) |> 
  mutate(browser = "Tiempo total (minutos)") |> 
  bind_rows(cookies_navegador) |> 
  mutate(etiqueta = ifelse(browser != "Tiempo total (minutos)", paste0(dispositivo, " - ", browser), dispositivo))

# Creación del treemap
cookies_treemap |> 
  plot_ly(
    type = "treemap",
    labels = ~etiqueta,
    parents = ~ifelse(dispositivo == "Tiempo total (minutos)", "", browser),
    values = ~tiempo_total,
    hoverinfo = "label+value+percent parent+percent root",
    textinfo = "label+value+percent parent+percent root") |> 
  add_trace(branchvalues = "total", name = "")
```

Segun el grafico podemos observar que los navegadores que mas tiempo de permanencia tienen en la pagina web son Chrome, Safari y Firefox, de los cuales se destaca el uso de dispositivos de escritorio para Chrome y Firefox y el uso de movil para Safari.







